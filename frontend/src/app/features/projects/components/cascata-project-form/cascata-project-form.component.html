<form [formGroup]="projectForm" (ngSubmit)="onSubmit()">

  <app-accordion-panel
    title="Projeto"
    [required]="true"
    [isOpenExternal]="panelStates.project"
    [disabled]="false"
    (toggled)="onPanelToggled('project', $event)"
    (attemptedToggle)="onAttemptedToggle('project')"
  >
    <div class="form-grid form-grid-4">
      <app-select
        label="Template"
        placeholder="Selecione o template"
        formControlName="template"
        [options]="templateOptions"
        [control]="getControl('template')"
        [required]="true"
        [allowClear]="true"
      ></app-select>
      <app-input
        label="Nome"
        placeholder="Informe o nome"
        formControlName="name"
        [control]="getControl('name')"
        [required]="true"
      ></app-input>
      <app-select
        label="Tipo"
        placeholder="Selecione o tipo"
        formControlName="type"
        [options]="projectTypeOptions"
        [control]="getControl('type')"
        [required]="true"
        [allowClear]="true"
      ></app-select>
      <app-input
        label="Data de início"
        type="date"
        placeholder="Data de início"
        formControlName="startDate"
        [control]="getControl('startDate')"
        [required]="true"
        class="form-input-datepicker"
      ></app-input>
    </div>
    <div class="form-grid form-grid-4">
      <app-input
        label="Prazo limite"
        placeholder="Prazo limite"
        type="date"
        formControlName="deadline"
        [control]="getControl('deadline')"
        [required]="true"
        class="form-input-datepicker"
      >
      </app-input>
    </div>

    <!-- Validation Errors -->
    @if (projectForm.errors && (projectForm.errors['deadlineTooEarly'] || projectForm.errors['startDateTooLate'] || projectForm.errors['stageExceedsDeadline'])) {
      <div class="validation-errors">
        @if (projectForm.errors['deadlineTooEarly']) {
          <div class="error-message">
            <img src="assets/icons/alert-triangle.svg" alt="Erro" class="error-icon" />
            <span>{{ getDeadlineErrorMessage() }}</span>
          </div>
        }
        @if (projectForm.errors['startDateTooLate']) {
          <div class="error-message">
            <img src="assets/icons/alert-triangle.svg" alt="Erro" class="error-icon" />
            <span>{{ getStartDateErrorMessage() }}</span>
          </div>
        }
        @if (projectForm.errors['stageExceedsDeadline']) {
          <div class="error-message">
            <img src="assets/icons/alert-triangle.svg" alt="Erro" class="error-icon" />
            <span>{{ getStageExceedsDeadlineMessage() }}</span>
          </div>
        }
      </div>
    }
    <div class="panel-actions">
      <button type="button" class="btn btn-primary" (click)="continueToNextPanel('project')">Continuar</button>
    </div>
  </app-accordion-panel>

  <app-accordion-panel
    title="Etapas"
    [required]="true"
    [isOpenExternal]="panelStates.steps"
    [disabled]="!canOpenPanel('steps')"
    (toggled)="onPanelToggled('steps', $event)"
    (attemptedToggle)="onAttemptedToggle('steps')"
  >
    <div class="steps-container">
      <table class="steps-table">
        <thead>
          <tr>
            <th>Sequência</th>
            <th>Nome da etapa</th>
            <th class="text-start">Faixa de aplicação</th>
            <th>Peso</th>
            <th>Ação</th>
          </tr>
        </thead>
        <tbody formArrayName="steps">
          @for (step of stepsFormArray.controls; track trackByIndex($index); let i = $index) {
            <tr [formGroupName]="i">
              <td class="cell-name">{{ step.get('sequence')?.value }}</td>
              <td class="cell-name">{{ step.get('name')?.value }}</td>
              <td class="cell-date-range">
                <span class="date-range-label">Período:</span>
                <span class="date-range-value">{{ step.get('dateRange')?.value || 'A definir' }}</span>
              </td>
              <td class="cell-weight">{{ step.get('weight')?.value }}</td>
              <td class="cell-actions">
                <button
                  type="button"
                  class="btn-icon btn-edit"
                  title="Editar etapa"
                  (click)="editStep(i)"
                >
                  <img src="assets/icons/pen-edit.svg" alt="Editar" />
                </button>
                <button
                  type="button"
                  class="btn-icon btn-delete"
                  title="Remover etapa"
                  (click)="removeStep(i)"
                  [disabled]="stepsFormArray.length === 1"
                >
                  <img src="assets/icons/trash.svg" alt="Remover" />
                </button>
              </td>
            </tr>
          }
        </tbody>
      </table>
      @if (hasStagesExceedDeadlineError()) {
        <div class="validation-errors">
          <div class="error-message">
            <img src="assets/icons/alert-triangle.svg" alt="Erro" class="error-icon" />
            <span>{{ getStagesExceedDeadlineMessage() }}</span>
          </div>
        </div>
      }
      <div class="d-flex justify-content-end">
        <button
            type="button"
            class="btn btn-secundary"
            (click)="addStep()"
          >
            <span class="plus-icon">+</span>
            Adicionar etapa
          </button>
      </div>
      <div class="panel-actions">
        <button
          type="button"
          class="btn btn-primary"
          (click)="continueToNextPanel('steps')"
          [disabled]="hasStagesExceedDeadlineError() || stepsFormArray.length === 0"
        >
          Continuar
        </button>
      </div>
    </div>
  </app-accordion-panel>

  <app-accordion-panel
    title="Representantes"
    [required]="true"
    [isOpenExternal]="panelStates.representatives"
    [disabled]="!canOpenPanel('representatives')"
    (toggled)="onPanelToggled('representatives', $event)"
    (attemptedToggle)="onAttemptedToggle('representatives')"
  >
    <div class="steps-container">
      <table class="representatives-table">
        <thead>
          <tr>
            <th>Nome</th>
            <th class="text-start">Sobrenome</th>
            <th class="text-start">Email</th>
            <th>Peso</th>
            <th class="text-start">Encargos</th>
            <th>Ação</th>
          </tr>
        </thead>
        <tbody formArrayName="representatives">
          @for (rep of representativesFormArray.controls; track rep; let i = $index) {
            <tr [formGroupName]="i">
              <td class="cell-name">{{ rep.get('firstName')?.value }}</td>
              <td class="cell-name">{{ rep.get('lastName')?.value }}</td>
              <td class="cell-name">{{ rep.get('email')?.value }}</td>
              <td class="cell-weight">{{ rep.get('weight')?.value }}</td>
              <td class="cell-name">{{ rep.get('roles')?.value?.join(', ') || '-' }}</td>
              <td class="cell-actions">
                <button
                  type="button"
                  class="btn-icon btn-edit"
                  title="Editar representante"
                  (click)="editRepresentative(i)"
                >
                  <img src="assets/icons/pen-edit.svg" alt="Editar" />
                </button>
                <button
                  type="button"
                  class="btn-icon btn-delete"
                  title="Remover representante"
                  (click)="removeRepresentative(i)"
                  [disabled]="representativesFormArray.length === 1"
                >
                  <img src="assets/icons/trash.svg" alt="Remover" />
                </button>
              </td>
            </tr>
          }
        </tbody>
      </table>
      <div class="d-flex justify-content-end">
        <button
            type="button"
            class="btn btn-secundary"
            (click)="addRepresentative()"
          >
            <span class="plus-icon">+</span>
            Adicionar representante
          </button>
      </div>
      <div class="panel-actions">
        <button
          type="button"
          class="btn btn-primary"
          (click)="continueToNextPanel('representatives')"
          [disabled]="representativesFormArray.length === 0"
        >
          Continuar
        </button>
      </div>
    </div>
  </app-accordion-panel>

  <app-accordion-panel
    title="Questionários"
    [required]="true"
    [isOpenExternal]="panelStates.questionnaires"
    [disabled]="!canOpenPanel('questionnaires')"
    (toggled)="onPanelToggled('questionnaires', $event)"
    (attemptedToggle)="onAttemptedToggle('questionnaires')"
  >
    <div class="steps-container">
      <div class="" [class.scrollable]="questionnairesFormArray.controls.length > 5">
        <table class="questionnaires-table">
          <thead>
            <tr>
              <th>Sequência</th>
              <th class="text-start">Nome</th>
              <th class="text-start">Data de início</th>
              <th class="text-start">Data de término</th>
              <th>Ação</th>
            </tr>
          </thead>
          <tbody formArrayName="questionnaires">
            @for (q of questionnairesFormArray.controls; track q; let i = $index) {
              <tr [formGroupName]="i">
                <td class="cell-name">{{ q.get('sequence')?.value || '-' }}</td>
                <td class="cell-name">{{ q.get('name')?.value }}</td>
                <td class="cell-name">{{ q.get('applicationStartDate')?.value || '-' }}</td>
                <td class="cell-name">{{ q.get('applicationEndDate')?.value || '-' }}</td>
                <td class="cell-actions">
                  <button
                    type="button"
                    class="btn-icon"
                    title="Editar perguntas do questionário"
                    (click)="editQuestionnaire(i)"
                  >
                    <img src="assets/icons/pen-edit.svg" alt="Editar" />
                  </button>
                  <button
                    type="button"
                    class="btn-icon"
                    title="Remover questionário"
                    disabled
                  >
                    <img src="assets/icons/trash.svg" alt="Remover" />
                  </button>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
      <div class="panel-actions">
        <button type="button" class="btn btn-primary" (click)="continueToNextPanel('questionnaires')">Continuar</button>
      </div>
    </div>
  </app-accordion-panel>

  <div class="page-actions">
    <button
      type="submit"
      class="btn btn-primary"
      [disabled]="projectForm.invalid"
    >
      Salvar projeto
    </button>
  </div>
</form>
