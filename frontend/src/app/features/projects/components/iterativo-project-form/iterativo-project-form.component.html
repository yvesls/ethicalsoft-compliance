<form [formGroup]="projectForm" (ngSubmit)="onSubmit()">

  <app-accordion-panel
    title="Projeto"
    [required]="true"
    [isOpenExternal]="panelStates.project"
    [disabled]="false"
    (toggled)="onPanelToggled('project', $event)"
    (attemptedToggle)="onAttemptedToggle('project')"
  >
    <div class="form-grid form-grid-4">
      <app-select
        label="Template"
        placeholder="Selecione o template"
        formControlName="template"
        [options]="templateOptions"
        [control]="getControl('template')"
        [required]="true"
        [allowClear]="true"
      ></app-select>
      <app-input
        label="Nome"
        placeholder="Informe o nome"
        formControlName="name"
        [control]="getControl('name')"
        [required]="true"
      ></app-input>
      <app-select
        label="Tipo"
        placeholder="Selecione o tipo"
        formControlName="type"
        [options]="projectTypeOptions"
        [control]="getControl('type')"
        [required]="true"
        [allowClear]="true"
      ></app-select>
      <app-input
        label="Data de início"
        type="date"
        placeholder="Data de início"
        formControlName="startDate"
        [control]="getControl('startDate')"
        [required]="true"
        class="form-input-datepicker"
      ></app-input>
    </div>

    <div class="form-grid form-grid-4">
      <app-input
        label="Prazo limite"
        placeholder="Prazo limite"
        type="date"
        formControlName="deadline"
        [control]="getControl('deadline')"
        class="form-input-datepicker"
      >
      </app-input>
      <app-input
        label="Duração das Iterações (dias úteis)"
        placeholder="Informe a duração das Iterações"
        type="number"
        formControlName="iterationDuration"
        [control]="getControl('iterationDuration')"
        [required]="true"
      ></app-input>
      <app-input
        label="Número de Iterações (calculado)"
        type="number"
        formControlName="iterationCount"
        [control]="getControl('iterationCount')"
        [readonly]="true"
      ></app-input>
    </div>

    <div class="panel-actions">
      <button type="button" class="btn btn-primary" (click)="continueToNextPanel('project')">Continuar</button>
    </div>
  </app-accordion-panel>

  <app-accordion-panel
    title="Etapas"
    [required]="true"
    [isOpenExternal]="panelStates.stages"
    [disabled]="!canOpenPanel('stages')"
    (toggled)="onPanelToggled('stages', $event)"
    (attemptedToggle)="onAttemptedToggle('stages')"
  >
    <div class="steps-container">
      <table class="steps-table steps-table-iterativo">
        <thead>
          <tr>
            <th>Nome da etapa</th>
            <th>Peso</th>
            <th>Ação</th>
          </tr>
        </thead>
        <tbody formArrayName="stages">
          @for (stage of stagesFormArray.controls; track $index; let i = $index) {
            <tr [formGroupName]="i">
              <td class="cell-name">{{ stage.get('name')?.value }}</td>
              <td class="cell-weight">{{ stage.get('weight')?.value }}</td>
              <td class="cell-actions">
                <button
                  type="button"
                  class="btn-icon btn-edit"
                  title="Editar etapa"
                  (click)="editStage(i)"
                >
                  <img src="assets/icons/pen-edit.svg" alt="Editar" />
                </button>
                <button
                  type="button"
                  class="btn-icon btn-delete"
                  title="Remover etapa"
                  (click)="removeStage(i)"
                  [disabled]="stagesFormArray.length === 1"
                >
                  <img src="assets/icons/trash.svg" alt="Remover" />
                </button>
              </td>
            </tr>
          }
        </tbody>
      </table>
      <div class="d-flex justify-content-end">
        <button
            type="button"
            class="btn btn-secundary"
            (click)="addStage()"
          >
            <span class="plus-icon">+</span>
            Adicionar etapa
          </button>
      </div>
      <div class="panel-actions">
        <button type="button" class="btn btn-primary" (click)="continueToNextPanel('stages')">Continuar</button>
      </div>
    </div>
  </app-accordion-panel>

  <app-accordion-panel
    title="Representantes"
    [required]="true"
    [isOpenExternal]="panelStates.representatives"
    [disabled]="!canOpenPanel('representatives')"
    (toggled)="onPanelToggled('representatives', $event)"
    (attemptedToggle)="onAttemptedToggle('representatives')"
  >
    <div class="representatives-container">
      <table class="steps-table representatives-table">
        <thead>
          <tr>
            <th>Nome</th>
            <th class="text-start">Sobrenome</th>
            <th class="text-start">Email</th>
            <th>Peso</th>
            <th class="text-start">Encargos</th>
            <th>Ação</th>
          </tr>
        </thead>
        <tbody formArrayName="representatives">
          @for (rep of representativesFormArray.controls; track rep; let i = $index) {
            <tr [formGroupName]="i">
              <td class="cell-name">{{ rep.get('firstName')?.value }}</td>
              <td class="cell-name">{{ rep.get('lastName')?.value }}</td>
              <td class="cell-name">{{ rep.get('email')?.value }}</td>
              <td class="cell-weight">{{ rep.get('weight')?.value }}</td>
              <td class="cell-name">{{ rep.get('roles')?.value?.join(', ') || '-' }}</td>
              <td class="cell-actions">
                <button
                  type="button"
                  class="btn-icon btn-edit"
                  title="Editar representante"
                  (click)="editRepresentative(i)"
                >
                  <img src="assets/icons/pen-edit.svg" alt="Editar" />
                </button>
                <button
                  type="button"
                  class="btn-icon btn-delete"
                  title="Remover representante"
                  (click)="removeRepresentative(i)"
                >
                  <img src="assets/icons/trash.svg" alt="Remover" />
                </button>
              </td>
            </tr>
          }
        </tbody>
      </table>
      <div class="d-flex justify-content-end">
        <button
          type="button"
          class="btn btn-secundary"
          (click)="addRepresentative()"
        >
          <span class="plus-icon">+</span> Adicionar representante
        </button>
      </div>
      <div class="panel-actions">
        <button type="button" class="btn btn-primary" (click)="continueToNextPanel('representatives')">Continuar</button>
      </div>
    </div>
  </app-accordion-panel>

  <app-accordion-panel
    title="Questionários"
    [required]="true"
    [isOpenExternal]="panelStates.questionnaires"
    [disabled]="!canOpenPanel('questionnaires')"
    (toggled)="onPanelToggled('questionnaires', $event)"
    (attemptedToggle)="onAttemptedToggle('questionnaires')"
  >
    <div class="steps-container">
      <div class="table-wrapper" [class.scrollable]="questionnairesFormArray.controls.length > 5">
        <table class="questionnaires-table">
          <thead>
            <tr>
              <th>Nome</th>
              <th class="text-start">Iteração</th>
              <th class="text-center">Peso</th>
              <th class="text-start">Faixa de aplicação</th>
              <th class="text-center">Ação</th>
            </tr>
          </thead>
          <tbody formArrayName="questionnaires">
            @for (questionnaire of questionnairesFormArray.controls; track $index; let i = $index) {
              <tr [formGroupName]="i">
                <td class="cell-name">{{ questionnaire.get('name')?.value }}</td>
                <td class="cell-name">{{ questionnaire.get('iteration')?.value }}</td>
                <td class="cell-weight">{{ questionnaire.get('weight')?.value }}</td>
                <td class="cell-name">{{ questionnaire.get('dateRange')?.value || '-' }}</td>
                <td class="cell-actions d-flex justify-content-center">
                  <button
                    type="button"
                    class="btn-icon"
                    title="Editar questionário"
                    (click)="editQuestionnaire(i)"
                  >
                    <img src="assets/icons/pen-edit.svg" alt="Editar" />
                  </button>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
      <div class="d-flex justify-content-start mt-2">
        <button
          type="button"
          class="btn btn-primary"
          (click)="importQuestionnaires()"
        >
          Importar questionários
        </button>
      </div>
      <div class="panel-actions">
        <button type="button" class="btn btn-primary" (click)="continueToNextPanel('questionnaires')">Continuar</button>
      </div>
    </div>
  </app-accordion-panel>

  <div class="page-actions">
    <button
      type="submit"
      class="btn btn-primary"
      [disabled]="projectForm.invalid"
    >
      Salvar projeto
    </button>
  </div>
</form>
